#include "common_args.hpp"

#include "message.hpp"
#include <client.hpp>

#include <thread>

std::string_view MSG_1024 = R"(
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =================================================================================
)";
std::string_view MSG_1138 = R"(
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================
)";
std::string_view MSG_454 = R"(
    =======================================================================================================================================================
    =======================================================================================================================================================
    =======================================================================================================================================
)";
std::string_view MSG_LIST[] = { MSG_1024, MSG_454, MSG_1138 };

void send_message(IPC::PipeClient& client, std::string_view content)
{
    static IPC::Message msg {
        .kind = IPC::MessageKind::DATA,
        .pid = getpid(),
    };
    if (!msg.set_body(content)) {
        std::println(stderr, "Process {}: Content too long for buffer (size: {}, max: {}).",
            msg.pid, content.length(), sizeof(msg.body));
        return;
    }
    if (!client.write_message(msg)) {
        std::println(stderr, "Process {}: Failed to send message.", msg.pid);
        return;
    }
    std::println("Process {}: Sent {} bytes: Content {}", msg.pid, msg.size(), IPC::to_string(msg));
}

void send_stop_message(const IPC::PipeClient& client)
{
    static IPC::Message msg {
        .kind = IPC::MessageKind::STOP,
        .pid = getpid(),
    };
    if (!client.write_message(msg)) {
        std::println(stderr, "Process {}: Failed to send message.", msg.pid);
        return;
    }
    std::println("Process {}: Sent {} bytes: Content {}", msg.pid, msg.size(), IPC::to_string(msg));
}

void run_writer(IPC::PipeClient& client)
{
    for (size_t i = 0; i < 5; i++) {
        const std::string_view content = MSG_LIST[i % std::size(MSG_LIST)];
        send_message(client, content);
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
    send_stop_message(client);
}

int main(int argc, char* argv[])
{
    const Options options = Args::parse<Options>(argc, argv, command_handler);
    const auto pipename = std::move(options.pipename);

    IPC::PipeClient client { pipename };
    if (!client.init().has_value()) {
        std::exit(EXIT_FAILURE);
    }

    run_writer(client);
    return 0;
}
